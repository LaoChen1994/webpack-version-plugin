"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("path"),e=require("url"),r=require("fs"),n=require("chalk");function i(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var o,a=i(t),s=i(r),c=i(n),l=function(){return(l=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function u(t,e,r,n){return new(r||(r=Promise))((function(i,o){function a(t){try{c(n.next(t))}catch(t){o(t)}}function s(t){try{c(n.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,s)}c((n=n.apply(t,e||[])).next())}))}function h(t,e){var r,n,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}exports.GEN_MODE=void 0,(o=exports.GEN_MODE||(exports.GEN_MODE={})).MERGE="merge",o.OVERITE="overwrite";var f="css",p="js",d="static",v=function(){function t(t){var e=t.jsPublicPath,r=void 0===e?"":e,n=t.cssPublicPath,i=void 0===n?"":n,o=t.localPath,a=void 0===o?"":o,s=t.isProduction,c=void 0!==s&&s,l=t.publicPath,u=void 0===l?"":l,h=t.mode,f=void 0===h?exports.GEN_MODE.OVERITE:h,p=t.jsVersionPath,d=void 0===p?"":p,v=t.cssVersionPath,y=void 0===v?"":v;this.jsPublicPath=r,this.cssPublicPath=i,this.localPath=a,this.isProduction=c,this.publicPath=u,this.mode=f,this.jsVersionPath=d,this.cssVersionPath=y}return t.prototype.getStaticPath=function(t){var r=t.match(/\.js$/),n=t.match(/.css$/),i="";return i=this.isProduction?new e.URL(t,r?this.jsPublicPath:n?this.cssPublicPath:this.publicPath).href:a.default.join(this.localPath,t),{type:r?p:n?f:d,path:i}},t.prototype.apply=function(t){var e=this,r={},n={},i=a.default.resolve(__dirname,this.jsVersionPath),o=a.default.resolve(__dirname,this.cssVersionPath);t.hooks.emit.tapAsync("myPlugin",(function(t,a){return u(e,void 0,void 0,(function(){var e,u,d=this;return h(this,(function(h){if(t.chunks.forEach((function(t){var e=t.name;t.files.forEach((function(t){console.log("this ->",d);var i=d.getStaticPath(t),o=i.type,a=i.path;switch(o){case p:r[e]=a;break;case f:n[e]=a}}))})),this.mode===exports.GEN_MODE.MERGE)try{e=JSON.parse(s.default.readFileSync(i).toString()||"{}"),u=JSON.parse(s.default.readFileSync(o).toString()||"{}"),r=l(l({},r),e),n=l(l({},n),u)}catch(t){console.log("读取文件错误 ->",t)}return s.default.writeFileSync(i,JSON.stringify(r)),s.default.writeFileSync(o,JSON.stringify(n)),console.log(c.default.yellow("js version 文件已经生成"+i)),console.log(c.default.yellow("css version 文件已经生成"+o)),a(),[2]}))}))}))},t}();exports.VersionPlugin=v;
